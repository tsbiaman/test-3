name: Deploy LOCAL_3 to TSBI

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    env:
      SITE_ID: local-3-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine target environment
        id: env
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ENVIRONMENT=preview" >>$GITHUB_ENV
            PR_NUMBER=${{ github.event.pull_request.number }}
            echo "PR_NUMBER=$PR_NUMBER" >>$GITHUB_ENV
            echo "DOMAIN=local3-backend-pr-${PR_NUMBER}.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=${{ github.head_ref }}" >>$GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ENVIRONMENT=production" >>$GITHUB_ENV
            echo "DOMAIN=local3-backend.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=main" >>$GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "ENVIRONMENT=staging" >>$GITHUB_ENV
            echo "DOMAIN=staging-local3-backend.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=staging" >>$GITHUB_ENV
          else
            echo "ENVIRONMENT=develop" >>$GITHUB_ENV
            echo "DOMAIN=develop-local3-backend.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=${{ github.ref_name }}" >>$GITHUB_ENV
          fi

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TSBI_HOST }}
          username: ${{ secrets.TSBI_USER }}
          key: ${{ secrets.TSBI_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /data/ecosystem
            ./scripts/deploy-app.sh \
              "${{ env.SITE_ID }}" \
              "${{ env.ENVIRONMENT }}" \
              --branch "${{ env.BRANCH }}" \
              --domain "${{ env.DOMAIN }}"
            echo "ðŸš€ Deployed ${SITE_ID} to ${ENVIRONMENT} (${DOMAIN})"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    env:
      SITE_ID: local-3-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine target environment
        id: env
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ENVIRONMENT=preview" >>$GITHUB_ENV
            PR_NUMBER=${{ github.event.pull_request.number }}
            echo "PR_NUMBER=$PR_NUMBER" >>$GITHUB_ENV
            echo "DOMAIN=local3-pr-${PR_NUMBER}.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=${{ github.head_ref }}" >>$GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ENVIRONMENT=production" >>$GITHUB_ENV
            echo "DOMAIN=local3.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=main" >>$GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "ENVIRONMENT=staging" >>$GITHUB_ENV
            echo "DOMAIN=staging-local3.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=staging" >>$GITHUB_ENV
          else
            echo "ENVIRONMENT=develop" >>$GITHUB_ENV
            echo "DOMAIN=develop-local3.tsbi.fun" >>$GITHUB_ENV
            echo "BRANCH=${{ github.ref_name }}" >>$GITHUB_ENV
          fi

      - name: Deploy Frontend via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TSBI_HOST }}
          username: ${{ secrets.TSBI_USER }}
          key: ${{ secrets.TSBI_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /data/ecosystem
            ./scripts/deploy-app.sh \
              "${{ env.SITE_ID }}" \
              "${{ env.ENVIRONMENT }}" \
              --branch "${{ env.BRANCH }}" \
              --domain "${{ env.DOMAIN }}"
            echo "ðŸš€ Deployed ${SITE_ID} to ${ENVIRONMENT} (${DOMAIN})"

      - name: Comment PR with preview links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            if (Number.isNaN(prNumber)) return;
            const backendDomain = `local3-backend-pr-${prNumber}.tsbi.fun`;
            const frontendDomain = `local3-pr-${prNumber}.tsbi.fun`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸš€ **Preview deployed!**\n\n- Backend: https://${backendDomain}\n- Frontend: https://${frontendDomain}`,
            });
